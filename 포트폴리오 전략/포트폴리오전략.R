library(quantmod)
library(PerformanceAnalytics)
library(magrittr)

#quantmod ??Ű?? : ?ֽĵ????? ??Ű?? 

symbols = c('SPY', # ?̱? ?ֽ?
            'IEV', # ��?? ?ֽ? 
            'EWJ', # ?Ϻ? ?ֽ?
            'EEM', # ?̸?¡ ?ֽ?
            'TLT', # ?̱? ????ä
            'IEF', # ?̱? ?߱?ä
            'IYR', # ?̱? ????
            'RWX', # ?۷ι? ????
            'GLD', # ??
            'DBC'  # ??ǰ
)

#?ֽĵ????? ??��?��? 
#?ֽ? ??????, ȯ�� ??????, ?????? ????, ?? ?? FRED???? ?????? ?????ʹ? ?? ??��?? ?? ?ִ?.
getSymbols(symbols, src = 'yahoo')


#??����???? ??��?��? ????Ʈ?? ????
prices = do.call(cbind,
                 lapply(symbols, function(x) Ad(get(x)))) %>%
  setNames(symbols)

#???ͷ? ????
rets = Return.calculate(prices) %>% na.omit()



library(tidyr)
library(dplyr)
library(corrplot)

#etf?? ?????? ???ϱ?
cor(rets) %>%
  corrplot(method = 'color', type = 'lower',
           addCoef.col = 'black', number.cex = 0.7,
           tl.cex = 1, tl.srt = 0, tl.col = 'black',
           col =
             colorRampPalette(c('blue', 'white', 'red'))(200),
           mar = c(0,0,0.5,0))

#?л?-???л? ????
covmat = cov(rets)

##?ּҺ??? ??Ʈ??????
#slsqp()

#?????Լ?
objective = function(w) {
  obj = t(w) %*% covmat %*% w
  return(obj)
}

#��??��?? 
hin.objective = function(w) {
  return(w)
}

#?ڻ걺??�� 1?̶??? ��??��??
heq.objective = function(w) {
  sum_w = sum(w)
  return( sum_w - 1 )
}

#????
library(nloptr)

result = slsqp( x0 = rep(0.1, 10),    #?ʱⰪ (0.1, 10??)
                fn = objective,       #?????Լ?
                hin = hin.objective,  #?ε?�� ��??��??
                heq = heq.objective)  #??�� ��??��??

#????ȭ?? ??��?? ??, ?ּҺл? ??Ʈ?????��? ?????ϴ? ?ڻ????? ???? ????
print(result$par)

#?????? ??�� ?????Լ? fn?? ?Է??Ͽ?�� ?? ???��? ?ᱣ??��?ν?, ??Ʈ???????? ?л?�� ?ǹ?
print(result$value)

w_1 = result$par %>% round(., 4) %>%
  setNames(colnames(rets))

print(w_1)
sum(w_1)


#solve.QP()

Dmat = covmat                                    #?л?-???л? ????
dvec = rep(0, 10)                                #???ͺκ? (??Ʈ?????? ????ȭ?????? ???? x)
Amat = t(rbind(rep(1, 10), diag(10), -diag(10))) #��??��??(?º?)
bvec = c(1, rep(0, 10), -rep(1, 10))             #��??��??(?캯) (?????? ????1, ?? ?????? 0????ŭ)
meq = 1                                          #??�� ��??��?? ???? (?????? ???? 1)

#????
library(quadprog)
result = solve.QP(Dmat, dvec, Amat, bvec, meq)

#????ȭ?? ??��????, ?? ?ּҺл? ??Ʈ?????��? ?????ϴ? ?ڻ????? ???ں???
print(result$solution)
#$solution ???? ?????? ??�� ?????Լ??? ?Է???�� ?? ???��? ??????, ??Ʈ???????? ?л?
print(result$value)


w_2 = result$solution %>% round(., 4) %>%
  setNames(colnames(rets))

print(w_2)
sum(w_2)


#optimalPortfolio() 
library(RiskPortfolios)

w_3 = optimalPortfolio(covmat,
                       control = list(type = 'minvol',
                                      constraint = 'lo')) %>%
  round(., 4) %>%
  setNames(colnames(rets))

print(w_3) 
sum(w_3)


#???????? ????
library(ggplot2)

data.frame(w_1) %>%
  ggplot(aes(x = factor(rownames(.), levels = rownames(.)),
             y = w_1)) +
  geom_col() +
  xlab(NULL) + ylab(NULL)


#��??��?? ?߰? slsqp()
result = slsqp( x0 = rep(0.1, 10),
                fn = objective,
                hin = hin.objective,
                heq = heq.objective,
                lower = rep(0.05, 10), #?ּ????ں???
                upper = rep(0.20, 10)) #?ִ????ں???

w_4 = result$par %>% round(., 4) %>%
  setNames(colnames(rets))

print(w_4)

#��??��?? ?߰? solve.QP()
Dmat = covmat
dvec = rep(0, 10)
Amat = t(rbind(rep(1, 10), diag(10), -diag(10)))
bvec = c(1, rep(0.05, 10), -rep(0.20, 10)) #?ּ? ?ִ? ???ں???
meq = 1

result = solve.QP(Dmat, dvec, Amat, bvec, meq)

w_5 = result$solution %>% round(., 4) %>%
  setNames(colnames(rets))

print(w_5)

#��??��?? ?߰? optimalProtfolio()
w_6 = optimalPortfolio(covmat,
                       control = list(type = 'minvol',
                                      constraint = 'user', #��??��?? ??��?Է?
                                      LB = rep(0.05, 10),
                                      UB = rep(0.20, 10))) %>%
  round(., 4) %>%
  setNames(colnames(rets))

print(w_6)


#?ּ? ?ִ? ????��?? ????????
data.frame(w_4) %>%
  ggplot(aes(x = factor(rownames(.), levels = rownames(.)),
             y = w_4)) +
  geom_col() +
  geom_hline(aes(yintercept = 0.05), color = 'red') +
  geom_hline(aes(yintercept = 0.20), color = 'red') +
  xlab(NULL) + ylab(NULL)

#?? ?ڻ꺰 ��??��?? ?߰?
Dmat = covmat
dvec = rep(0, 10)
Amat = t(rbind(rep(1, 10), diag(10), -diag(10))) 
bvec = c(1, c(0.10, 0.10, 0.05, 0.05, 0.10,   #???ڻ꺰 ��??��???߰?
              0.10, 0.05, 0.05, 0.03, 0.03),
         -c(0.25, 0.25, 0.20, 0.20, 0.20,
            0.20, 0.10, 0.10, 0.08, 0.08))  


meq = 1

result = solve.QP(Dmat, dvec, Amat, bvec, meq)

w_7 = result$solution %>%
  round(., 4) %>%
  setNames(colnames(rets))

print(w_7)


######?ִ??л? ??Ʈ??????
Dmat = covmat                                   #?л?-???л? ????
dvec = rep(0, 10)                               #???ͺκ? (??Ʈ?????? ????ȭ?????? ???? x)
Amat = t(rbind(sqrt(diag(covmat)), diag(10)))   #��??��??(?º?)
bvec = c(1, rep(0, 10))                         #��??��??(?캯)
meq = 1                                         #??����??��?? (?????? ???? 1)



result = solve.QP(Dmat, dvec, Amat, bvec, meq)  #solce.QP() ?Լ? ?????ؼ? ?ִ??л? ??Ʈ?????? ????

w = result$solution %>%
  round(., 4) %>%            #?ݿø?
  setNames(colnames(rets))   

print(w)

#????ȭ
w = (w / sum(w)) %>%
  round(., 4)

print(w)


#?׷???
data.frame(w) %>%
  ggplot(aes(x = factor(rownames(.), levels = rownames(.)),
             y = w)) +
  geom_col() +
  geom_col() +
  xlab(NULL) + ylab(NULL)



#optimalPortfolio() ?Լ? ????
w = optimalPortfolio(covmat,                                        #Min -DR ????�� ????
                     control = list(type = 'maxdiv',
                                    constraint = 'lo')) %>%
  round(., 4)

print(w)


##?ּ?& ?ִ? ???? ��??��?? ?߰?
Dmat = covmat                                            #?л?-???л? ????
dvec = rep(0, 10)                                        #???ͺκ? (??Ʈ?????? ????ȭ?????? ???? x)
Alb = -rep(0.05, 10) %*% matrix(1, 1, 10) + diag(10)     # -rep(0.05, 10) : -lb(?ּ?) ?κ? / matrix(1, 1, 10) : e^T ?κ? / diag(10) : I(??��????) ?κ? 
Aub = rep(0.20, 10) %*% matrix(1, 1, 10) - diag(10)      # rep(0.20, 10) : ub(?ִ?) ?κ? / matrix(1, 1, 10) : e^T ?κ? / diag(10) : I(??��????) ?κ?

Amat = t(rbind(sqrt(diag(covmat)), Alb, Aub))
bvec = c(1, rep(0, 10), rep(0, 10))
meq = 1

result = solve.QP(Dmat, dvec, Amat, bvec, meq)

w = result$solution 
w = (w / sum(w)) %>%
  round(., 4) %>%
  setNames(colnames(rets))

print(w)


#?ּ? & ?ִ? [5%, 20%] ��??��?? ?־ ?׷??? ?׷��???
data.frame(w) %>%
  ggplot(aes(x = factor(rownames(.), levels = rownames(.)),
             y = w)) +
  geom_col() +
  geom_hline(aes(yintercept = 0.05), color = 'red') +
  geom_hline(aes(yintercept = 0.20), color = 'red') +
  xlab(NULL) + ylab(NULL)



##?ڻ꺰��??��?? ?߰?
Dmat = covmat
dvec = rep(0, 10)
Alb = -c(0.10, 0.10, 0.05, 0.05, 0.10,            #?ּҺκ? ?ڻ꺰 ��??��??
         0.10, 0.05, 0.05, 0.03, 0.03) %*%        
  matrix(1, 1, 10) + diag(10)
Aub = c(0.25, 0.25, 0.20, 0.20, 0.20,             #?ִ??κ? ?ڻ꺰 ��??��??
        0.20, 0.10, 0.10, 0.08, 0.08) %*%
  matrix(1, 1, 10) - diag(10)

Amat = t(rbind(sqrt(diag(covmat)), Alb, Aub))
bvec = c(1, rep(0, 10), rep(0, 10))
meq = 1

result = solve.QP(Dmat, dvec, Amat, bvec, meq)

w = result$solution 
w = (w / sum(w)) %>%
  round(., 4) %>%
  setNames(colnames(rets))

print(w)

#?׷???
data.frame(w) %>%
  ggplot(aes(x = factor(rownames(.), levels = rownames(.)),
             y = w)) +
  geom_col() +
  geom_hline(aes(yintercept = 0.05), color = 'red') +
  geom_hline(aes(yintercept = 0.20), color = 'red') +
  xlab(NULL) + ylab(NULL)



#optimalPortfolio ?Լ??? ��??��?? ?߰??غ???
w_6 = optimalPortfolio(covmat,
                       control = list(type = 'maxdiv',
                                      constraint = 'user', #��??��?? ??��?Է?
                                      LB = c(0.10, 0.10, 0.05, 0.05, 0.10,0.10, 0.05, 0.05, 0.03, 0.03),
                                      UB = c(0.25, 0.25, 0.20, 0.20, 0.20,0.20, 0.10, 0.10, 0.08, 0.08) %>%
  round(., 4) %>%
  setNames(colnames(rets))))

print(w_6)


##��???⿩ ??Ʈ??????
#��???⿩?? ?Լ? ??????
get_RC = function(w, covmat) {
  port_vol = t(w) %*% covmat %*% w
  port_std = sqrt(port_vol)
  
  MRC = (covmat %*% w) / as.numeric(port_std)
  RC = MRC * w
  RC = c(RC / sum(RC))
  
  return(RC)
}

#?ֽ? 60% ä?? 40% ??Ʈ?????? ��???⿩?? Ȯ??
ret_stock_bond = rets[, c(1, 5)]                    #?????? : ?̱??ֽ? ???ͷ?(SPY), ?̱? ????ä(TLT)
cov_stock_bond = cov(ret_stock_bond)                #?л?-???л? ????
RC_stock_bond = get_RC(c(0.6, 0.4), cov_stock_bond) #��???⿩?? ???ϱ?
RC_stock_bond = round(RC_stock_bond, 4)             #?ݿø?

print(RC_stock_bond)


#rp() ?Լ??? ?Ἥ ????ȭ?ϱ?
library(cccp)

opt = rp(x0 = rep(0.1, 10),   #????ȭ?? ��?? ?ʱ??Է°?(???Ϻ??? 10%?? ?ֱ?)
         P = covmat,          #?л?-???л? ????
         mrc = rep(0.1, 10))  #??ǥ???ϴ? ?ڻ꺰 ��???⿩?? ??(???Ϻ??? 10%)


w = getx(opt) %>% drop()      #???????·? ??????
w = (w / sum(w)) %>%
  round(., 4) %>%
  setNames(colnames(rets))

print(w)

get_RC(w, covmat) %>% round(.,4)


#?ڻ꺰?? ?ٸ? ????�� ?????? ??Ʈ?????? ?????? 
opt = rp(x0 = rep(0.1, 10),
         P = covmat,
         mrc = c(0.15, 0.15, 0.15, 0.15, 0.10,
                 0.10, 0.05, 0.05, 0.05, 0.05))


w = getx(opt) %>% drop()
w = (w / sum(w)) %>%
  round(., 4) %>%
  setNames(colnames(rets))

get_RC(w, covmat)
print(w)

#?ε??? ??Ʈ?????? ????
# ??�� 200 ��???? ?ð??Ѿ׺??? ????
library(stringr)
library(dplyr)

KOR_ticker = read.csv('C:\\Users\\sjyoo\\Desktop\\????\\??Ʈ ????\\KOR_ticker.csv',row.names = 1, stringsAsFactors = FALSE) 

#?ڽ??? 200?? ??�� 200???? ??��?��?
KOSPI200 = KOR_ticker %>% 
  filter(???屸?? == 'KOSPI') %>%
  slice(1:200) %>%
  mutate(?ð??Ѿ׺??? = ?ð??Ѿ? / sum(?ð??Ѿ?))



#?ð?ȭ
library(ggplot2)

KOSPI200 %>% 
  ggplot(aes(x = reorder(��????, -?ð??Ѿ׺???), y = ?ð??Ѿ׺???)) +
  geom_point() +
  xlab('��????') +
  ylab('?ð??Ѿ׺???(%)') +
  scale_y_continuous(labels = scales::percent)


#?׸? ???̻? -> ??��?ϱ?
KOSPI200 %>% 
  ggplot(aes(x = reorder(��????, -?ð??Ѿ׺???), y = ?ð??Ѿ׺???)) +   #?ð??Ѿ׺???��?? x?? ��??
  geom_point() +
  xlab('��????') +
  ylab('?ð??Ѿ׺???(?α? ?????ϸ?)') +
  scale_y_log10() +                                                     #y?? ?αװ?��?? ?????ϸ?
  scale_x_discrete(breaks = KOSPI200[seq(1, 200, by = 5), '��????']) +  #x?? ?Ϻ?��???? ǥ??
  theme(axis.text.x = element_text(angle = 60, hjust = 1))              #x?? ???? ȸ??+ ��ġ����

#1??????��?? ?ڽ??? 200�� ???󰡴?(??��?ϴ?) ?????????¹?
KOSPI200 = KOSPI200 %>%
  mutate(?ż??ݾ? = 100000000 * ?ð??Ѿ׺???,
             ?ż??ּ? = ?ż??ݾ? / ��??)

KOSPI200 %>% select(?ż??ݾ?, ?ż??ּ?) %>% head()


#?Ҽ?�� ?? ??????(?ݿø??̳? ?ø??ϸ? ??��?ݾ׺??? Ŀ??????��)
KOSPI200 = KOSPI200 %>% mutate(?ż??ּ? = floor(?ż??ּ?))
KOSPI200 %>% select(?ż??ݾ?, ?ż??ּ?) %>% head()

#??��?ż??ݾ? ???ϱ?
inv_money = KOSPI200 %>% mutate(??��?ż??ݾ? = ��?? * ?ż??ּ?) %>%
  summarize(sum(??��?ż??ݾ?))

print(inv_money)

##???͸? ?̿??? ???ڽ??? ??Ʈ?????? ????
#PBR�� ?̿??? ????��???ϱ?
KOSPI200 = KOSPI200 %>% select(��????, PBR, ?ð??Ѿ׺???) %>%
  mutate(PBR = as.numeric(PBR)) 

#?ܼ???????
KOSPI200 = KOSPI200 %>%
  mutate(??ŷ = rank(PBR),
           ��?????? = ifelse(??ŷ <= 100, ?ð??Ѿ׺??? + 0.0005, ?ð??Ѿ׺??? - 0.0005),  #??�� 100?? ???????? / ??�� 100?? ???߰???
           ��?????? = ifelse(��?????? < 0, 0, ��??????),                                  #0?̸??? ��??�� ???ں??? 0 ��?? ����
           ��?????? = ��?????? / sum(��??????),                                           #?????? ??�� 1?? ???߱?��?? ?ٽð???
           ???? = ��?????? - ?ð??Ѿ׺???) 
library(tidyr)

head(KOSPI200)


KOSPI200 %>% filter(��?????? == 0)

#?ð?ȭ
KOSPI200 %>% 
  ggplot(aes(x = reorder(��????, -?ð??Ѿ׺???), y = ?ð??Ѿ׺???)) +
  geom_point() +
  geom_point(data = KOSPI200, aes(x = reorder(��????, -?ð??Ѿ׺???), y = ��??????),
             color = 'red', shape = 4) +
  xlab('��????') +
  ylab('????(%)') +
  coord_cartesian(ylim = c(0, 0.03)) +
  scale_x_discrete(breaks = KOSPI200[seq(1, 200, by = 5), '��????']) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 

#
KOSPI200_mod = KOSPI200 %>% arrange(PBR)

KOSPI200_mod %>% 
  ggplot(aes(x = reorder(��????, PBR), y = ????)) +
  geom_point() +
  geom_col(aes(x = reorder(��????, PBR), y = PBR /10000), fill = 'blue', alpha = 0.2) +
  xlab('��????') +
  ylab('????(%)') +
  scale_y_continuous(labels = scales::percent, 
                     sec.axis = sec_axis(~. * 10000, name = "PBR")) +
  scale_x_discrete(breaks = KOSPI200_mod[seq(1, 200, by = 10), '��????']) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))


#Z-score ��??ȭ?? ???Ϳ? ???? ???? ?ش?ȭ
KOSPI200_tilt = KOSPI200 %>%
  select(��????, PBR, ?ð??Ѿ׺???, ??ŷ) %>%
  mutate(zscore = -scale(??ŷ),
         cdf = pnorm(zscore),
         ???ں??? = ?ð??Ѿ׺??? * cdf,
         ???ں??? = ???ں??? / sum(???ں???),
         ???? = ???ں??? - ?ð??Ѿ׺???)

head(KOSPI200_tilt)

#?ð?ȭ
KOSPI200 %>% 
  ggplot(aes(x = reorder(��????, -?ð??Ѿ׺???), y = ?ð??Ѿ׺???)) +
  geom_point() +
  geom_point(data = KOSPI200_tilt, aes(x = reorder(��????, -?ð??Ѿ׺???), y = ???ں???),
             color = 'red', shape = 4) +
  xlab('��????') +
  ylab('????(%)') +
  coord_cartesian(ylim = c(0, 0.03)) +
  scale_x_discrete(breaks = KOSPI200[seq(1, 200, by = 5), '��????']) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 

#???? ?ð?ȭ
KOSPI200_tilt %>%
  ggplot(aes(x = reorder(��????, -?ð??Ѿ׺???), y = ????)) +
  geom_point() +
  geom_hline(aes(yintercept = 0.005), color = 'red') + 
  geom_hline(aes(yintercept = -0.005), color = 'red') +
  xlab('��????') +
  ylab('???? ????(%)') +
  scale_x_discrete(breaks = KOSPI200[seq(1, 200, by = 5), '��????']) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 
#???̰? ?ʹ?ŭ! -> ��??��?? ???ʿ???��

#��??��?? 50bp??��

while (max(abs(KOSPI200_tilt$????)) > (0.005 + 0.00001)) {
  KOSPI200_tilt = KOSPI200_tilt %>%
    mutate_at(vars(???ں???), list(~ifelse(???? < -0.005, ?ð??Ѿ׺??? - 0.005, ???ں???))) %>%  #???̰? 50bp ?̸??̸? -50bp
    mutate_at(vars(???ں???), list(~ifelse(???? > 0.005, ?ð??Ѿ׺??? + 0.005, ???ں???))) %>%  #???̰? 50bp ?ʰ??̸? +50bp
    mutate(???ں??? = ???ں??? / sum(???ں???), 
               ???? = ???ں??? - ?ð??Ѿ׺???)
}

head(KOSPI200_tilt)

#???? ?ð?ȭ
KOSPI200_tilt %>%
  ggplot(aes(x = reorder(��????, -?ð??Ѿ׺???), y = ????)) +
  geom_point() +
  geom_hline(aes(yintercept = 0.005), color = 'red') + 
  geom_hline(aes(yintercept = -0.005), color = 'red') +
  xlab('��????') +
  ylab('???? ????(%)') +
  scale_x_discrete(breaks = KOSPI200[seq(1, 200, by = 5), '��????']) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 

#???? ?ð?ȭ
KOSPI200 %>% 
  ggplot(aes(x = reorder(��????, -?ð??Ѿ׺???), y = ?ð??Ѿ׺???)) +
  geom_point() +
  geom_point(data = KOSPI200_tilt, aes(x = reorder(��????, -?ð??Ѿ׺???), y = ???ں???),
             color = 'red', shape = 4) +
  xlab('��????') +
  ylab('????(%)') +
  coord_cartesian(ylim = c(0, 0.03)) +
  scale_x_discrete(breaks = KOSPI200[seq(1, 200, by = 5), '��????']) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 

#PBR ?ð?ȭ
KOSPI200_tilt_mod = KOSPI200_tilt %>% arrange(PBR) 

KOSPI200_tilt_mod %>% 
  ggplot(aes(x = reorder(��????, PBR), y = ????)) +
  geom_point() +
  geom_col(aes(x = reorder(��????, PBR), y = PBR /2000), fill = 'blue', alpha = 0.2) +
  xlab('��????') +
  ylab('????(%)') +
  scale_y_continuous(labels = scales::percent, 
                     sec.axis = sec_axis(~. * 2000, name = "PBR")) +
  scale_x_discrete(breaks = KOSPI200_mod[seq(1, 200, by = 10), '��????']) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
